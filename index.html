<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScreenShare Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media (max-width: 640px) {
            .mobile-flex-col {
                flex-direction: column;
            }
        }
        
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-color: #1a202c;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-offline {
            background-color: #ef4444;
        }
        
        .status-online {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2">ScreenShare Lite</h1>
            <p class="text-gray-600">A lightweight alternative to Discord for screen sharing</p>
        </header>
        
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
            <div class="flex mobile-flex-col gap-6">
                <!-- Host Panel -->
                <div class="flex-1 bg-gray-50 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <span id="host-status" class="status-indicator status-offline"></span>
                        Host Controls
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Room ID</label>
                            <div class="flex">
                                <input type="text" id="room-id" class="flex-1 rounded-l-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Enter room name">
                                <button id="create-room" class="btn-primary rounded-l-none px-4">
                                    <i class="fas fa-door-open mr-2"></i>Create
                                </button>
                            </div>
                        </div>
                        
                        <div id="host-controls" class="space-y-4 hidden">
                            <div class="flex space-x-2">
                                <button id="start-screen-share" class="btn-primary flex-1">
                                    <i class="fas fa-desktop mr-2"></i>Share Screen
                                </button>
                                <button id="start-audio" class="btn-primary flex-1">
                                    <i class="fas fa-microphone mr-2"></i>Share Audio
                                </button>
                            </div>
                            
                            <div class="video-container">
                                <video id="host-video" autoplay muted playsinline></video>
                            </div>
                            
                            <div class="flex justify-center">
                                <button id="stop-sharing" class="btn-danger">
                                    <i class="fas fa-stop mr-2"></i>Stop Sharing
                                </button>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            Share this room ID with viewers. They can join using the viewer panel.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Viewer Panel -->
                <div class="flex-1 bg-gray-50 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <span id="viewer-status" class="status-indicator status-offline"></span>
                        Viewer Controls
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Room ID</label>
                            <div class="flex">
                                <input type="text" id="viewer-room-id" class="flex-1 rounded-l-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Enter room ID">
                                <button id="join-room" class="btn-primary rounded-l-none px-4">
                                    <i class="fas fa-sign-in-alt mr-2"></i>Join
                                </button>
                            </div>
                        </div>
                        
                        <div id="viewer-controls" class="hidden">
                            <div class="video-container">
                                <video id="viewer-video" autoplay playsinline></video>
                            </div>
                            
                            <div class="flex justify-center mt-4">
                                <button id="leave-room" class="btn-danger">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Leave Room
                                </button>
                            </div>
                        </div>
                        
                        <div id="viewer-waiting" class="hidden text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">Waiting for host to start sharing...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center text-sm text-gray-500">
            <p>Works on Android Chrome and other modern browsers. No installation required.</p>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" }
            ]
        };
        
        // WebSocket connection for signaling
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = wsProtocol + window.location.host + '/ws';
        let socket = null;
        
        // DOM elements
        const elements = {
            hostStatus: document.getElementById('host-status'),
            viewerStatus: document.getElementById('viewer-status'),
            roomId: document.getElementById('room-id'),
            createRoomBtn: document.getElementById('create-room'),
            hostControls: document.getElementById('host-controls'),
            startScreenShareBtn: document.getElementById('start-screen-share'),
            startAudioBtn: document.getElementById('start-audio'),
            hostVideo: document.getElementById('host-video'),
            stopSharingBtn: document.getElementById('stop-sharing'),
            viewerRoomId: document.getElementById('viewer-room-id'),
            joinRoomBtn: document.getElementById('join-room'),
            viewerControls: document.getElementById('viewer-controls'),
            viewerVideo: document.getElementById('viewer-video'),
            leaveRoomBtn: document.getElementById('leave-room'),
            viewerWaiting: document.getElementById('viewer-waiting')
        };
        
        // Application state
        let state = {
            isHost: false,
            roomId: null,
            peerConnection: null,
            localStream: null,
            screenStream: null,
            audioStream: null
        };
        
        // Initialize the application
        function init() {
            setupEventListeners();
            checkBrowserCompatibility();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            elements.createRoomBtn.addEventListener('click', createRoom);
            elements.joinRoomBtn.addEventListener('click', joinRoom);
            elements.startScreenShareBtn.addEventListener('click', startScreenShare);
            elements.startAudioBtn.addEventListener('click', startAudioShare);
            elements.stopSharingBtn.addEventListener('click', stopSharing);
            elements.leaveRoomBtn.addEventListener('click', leaveRoom);
            
            // Handle Enter key in input fields
            elements.roomId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createRoom();
            });
            
            elements.viewerRoomId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom();
            });
        }
        
        // Check browser compatibility
        function checkBrowserCompatibility() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Your browser does not support media devices. Please use a modern browser like Chrome or Firefox.');
                return;
            }
            
            if (!RTCPeerConnection) {
                alert('WebRTC is not supported by your browser. Please use a modern browser like Chrome or Firefox.');
                return;
            }
        }
        
        // Connect to WebSocket server
        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) return;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                console.log('WebSocket connected');
                if (state.isHost) {
                    elements.hostStatus.classList.remove('status-offline');
                    elements.hostStatus.classList.add('status-online');
                } else {
                    elements.viewerStatus.classList.remove('status-offline');
                    elements.viewerStatus.classList.add('status-online');
                }
            };
            
            socket.onclose = () => {
                console.log('WebSocket disconnected');
                if (state.isHost) {
                    elements.hostStatus.classList.remove('status-online');
                    elements.hostStatus.classList.add('status-offline');
                } else {
                    elements.viewerStatus.classList.remove('status-online');
                    elements.viewerStatus.classList.add('status-offline');
                }
                
                // Try to reconnect after a delay
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            socket.onmessage = handleWebSocketMessage;
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(event) {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);
            
            switch (message.type) {
                case 'offer':
                    if (!state.isHost) handleOffer(message);
                    break;
                case 'answer':
                    if (state.isHost) handleAnswer(message);
                    break;
                case 'ice-candidate':
                    handleICECandidate(message);
                    break;
                case 'room-created':
                    handleRoomCreated(message);
                    break;
                case 'room-joined':
                    handleRoomJoined(message);
                    break;
                case 'error':
                    handleErrorMessage(message);
                    break;
            }
        }
        
        // Create a new room as host
        function createRoom() {
            const roomId = elements.roomId.value.trim();
            if (!roomId) {
                alert('Please enter a room name');
                return;
            }
            
            state.isHost = true;
            state.roomId = roomId;
            
            connectWebSocket();
            
            // Show host controls
            elements.hostControls.classList.remove('hidden');
            elements.createRoomBtn.disabled = true;
            elements.roomId.disabled = true;
            
            // Initialize peer connection
            initializePeerConnection();
            
            // Send room creation message to server
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'create-room',
                    roomId: roomId
                }));
            }
        }
        
        // Join an existing room as viewer
        function joinRoom() {
            const roomId = elements.viewerRoomId.value.trim();
            if (!roomId) {
                alert('Please enter a room ID');
                return;
            }
            
            state.isHost = false;
            state.roomId = roomId;
            
            connectWebSocket();
            
            // Show viewer waiting state
            elements.viewerControls.classList.add('hidden');
            elements.viewerWaiting.classList.remove('hidden');
            elements.joinRoomBtn.disabled = true;
            elements.viewerRoomId.disabled = true;
            
            // Initialize peer connection
            initializePeerConnection();
            
            // Send room join message to server
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'join-room',
                    roomId: roomId
                }));
            }
        }
        
        // Initialize WebRTC peer connection
        function initializePeerConnection() {
            state.peerConnection = new RTCPeerConnection(config);
            
            state.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        roomId: state.roomId,
                        isHost: state.isHost
                    }));
                }
            };
            
            state.peerConnection.ontrack = (event) => {
                console.log('Received remote stream');
                if (state.isHost) {
                    // Host doesn't expect to receive streams
                } else {
                    if (event.streams && event.streams[0]) {
                        elements.viewerVideo.srcObject = event.streams[0];
                        elements.viewerWaiting.classList.add('hidden');
                        elements.viewerControls.classList.remove('hidden');
                    }
                }
            };
            
            state.peerConnection.onconnectionstatechange = () => {
                console.log('Connection state:', state.peerConnection.connectionState);
                if (state.peerConnection.connectionState === 'disconnected' ||
                    state.peerConnection.connectionState === 'failed') {
                    alert('Connection lost. Please try again.');
                    resetState();
                }
            };
        }
        
        // Start screen sharing
        async function startScreenShare() {
            try {
                // Check for screen sharing support
                if (!navigator.mediaDevices.getDisplayMedia) {
                    alert('Screen sharing is not supported in your browser');
                    return;
                }
                
                // Get screen stream
                state.screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 15 }
                    },
                    audio: false
                });
                
                // Add screen track to peer connection
                state.screenStream.getTracks().forEach(track => {
                    state.peerConnection.addTrack(track, state.screenStream);
                });
                
                // Show screen in host video element
                elements.hostVideo.srcObject = state.screenStream;
                
                // Handle when user stops sharing via browser UI
                state.screenStream.getVideoTracks()[0].onended = () => {
                    stopSharing();
                };
                
                // Create and send offer
                if (state.isHost) {
                    const offer = await state.peerConnection.createOffer();
                    await state.peerConnection.setLocalDescription(offer);
                    
                    socket.send(JSON.stringify({
                        type: 'offer',
                        sdp: offer.sdp,
                        roomId: state.roomId
                    }));
                }
                
                elements.startScreenShareBtn.disabled = true;
                elements.startScreenShareBtn.textContent = 'Screen Sharing';
                
            } catch (error) {
                console.error('Error starting screen share:', error);
                alert('Failed to start screen sharing: ' + error.message);
            }
        }
        
        // Start audio sharing
        async function startAudioShare() {
            try {
                // Get audio stream
                state.audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: false
                });
                
                // Add audio track to peer connection
                state.audioStream.getAudioTracks().forEach(track => {
                    state.peerConnection.addTrack(track, state.audioStream);
                });
                
                // Create and send offer if not already done
                if (state.isHost && !state.peerConnection.currentRemoteDescription) {
                    const offer = await state.peerConnection.createOffer();
                    await state.peerConnection.setLocalDescription(offer);
                    
                    socket.send(JSON.stringify({
                        type: 'offer',
                        sdp: offer.sdp,
                        roomId: state.roomId
                    }));
                }
                
                elements.startAudioBtn.disabled = true;
                elements.startAudioBtn.textContent = 'Audio Sharing';
                
            } catch (error) {
                console.error('Error starting audio share:', error);
                alert('Failed to start audio sharing: ' + error.message);
            }
        }
        
        // Handle offer from host
        async function handleOffer(message) {
            try {
                await state.peerConnection.setRemoteDescription(new RTCSessionDescription({
                    type: 'offer',
                    sdp: message.sdp
                }));
                
                const answer = await state.peerConnection.createAnswer();
                await state.peerConnection.setLocalDescription(answer);
                
                socket.send(JSON.stringify({
                    type: 'answer',
                    sdp: answer.sdp,
                    roomId: state.roomId
                }));
                
            } catch (error) {
                console.error('Error handling offer:', error);
                alert('Error handling offer: ' + error.message);
            }
        }
        
        // Handle answer from viewer
        async function handleAnswer(message) {
            try {
                await state.peerConnection.setRemoteDescription(new RTCSessionDescription({
                    type: 'answer',
                    sdp: message.sdp
                }));
            } catch (error) {
                console.error('Error handling answer:', error);
                alert('Error handling answer: ' + error.message);
            }
        }
        
        // Handle ICE candidate
        async function handleICECandidate(message) {
            try {
                if (message.candidate) {
                    await state.peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }
        
        // Handle room created confirmation
        function handleRoomCreated(message) {
            if (message.success) {
                console.log('Room created successfully');
            } else {
                alert('Failed to create room: ' + message.error);
                resetState();
            }
        }
        
        // Handle room joined confirmation
        function handleRoomJoined(message) {
            if (message.success) {
                console.log('Joined room successfully');
            } else {
                alert('Failed to join room: ' + message.error);
                resetState();
            }
        }
        
        // Handle error messages
        function handleErrorMessage(message) {
            alert('Error: ' + message.error);
            resetState();
        }
        
        // Stop sharing and clean up
        function stopSharing() {
            if (state.screenStream) {
                state.screenStream.getTracks().forEach(track => track.stop());
                state.screenStream = null;
            }
            
            if (state.audioStream) {
                state.audioStream.getTracks().forEach(track => track.stop());
                state.audioStream = null;
            }
            
            if (elements.hostVideo.srcObject) {
                elements.hostVideo.srcObject.getTracks().forEach(track => track.stop());
                elements.hostVideo.srcObject = null;
            }
            
            if (state.peerConnection) {
                state.peerConnection.close();
                state.peerConnection = null;
            }
            
            resetState();
        }
        
        // Leave room as viewer
        function leaveRoom() {
            if (elements.viewerVideo.srcObject) {
                elements.viewerVideo.srcObject.getTracks().forEach(track => track.stop());
                elements.viewerVideo.srcObject = null;
            }
            
            if (state.peerConnection) {
                state.peerConnection.close();
                state.peerConnection = null;
            }
            
            resetState();
        }
        
        // Reset application state
        function resetState() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'leave-room',
                    roomId: state.roomId,
                    isHost: state.isHost
                }));
            }
            
            state = {
                isHost: false,
                roomId: null,
                peerConnection: null,
                localStream: null,
                screenStream: null,
                audioStream: null
            };
            
            // Reset UI
            elements.hostStatus.classList.remove('status-online');
            elements.hostStatus.classList.add('status-offline');
            elements.viewerStatus.classList.remove('status-online');
            elements.viewerStatus.classList.add('status-offline');
            
            elements.hostControls.classList.add('hidden');
            elements.viewerControls.classList.add('hidden');
            elements.viewerWaiting.classList.add('hidden');
            
            elements.createRoomBtn.disabled = false;
            elements.joinRoomBtn.disabled = false;
            elements.roomId.disabled = false;
            elements.viewerRoomId.disabled = false;
            
            elements.startScreenShareBtn.disabled = false;
            elements.startScreenShareBtn.innerHTML = '<i class="fas fa-desktop mr-2"></i>Share Screen';
            
            elements.startAudioBtn.disabled = false;
            elements.startAudioBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i>Share Audio';
            
            elements.roomId.value = '';
            elements.viewerRoomId.value = '';
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
