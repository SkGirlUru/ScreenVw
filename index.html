<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Compartir Pantalla y Audio en Tiempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* ... (los mismos estilos que ya tenías) ... */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- ... (el mismo HTML que ya tenías) ... -->
    </div>
    <script>
        const peer = new Peer({
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
            debug: 3
        });

        let peerId = null;
        let mediaStream = null;
        let currentCall = null;
        let broadcastActive = false;
        let viewerActive = false;

        const elements = {
            // ... (los mismos elementos que ya tenías) ...
        };

        peer.on('open', (id) => {
            peerId = id;
            console.log('ID de Peer:', id);
        });

        peer.on('error', (err) => {
            console.error('Error de PeerJS:', err);
            updateStatus('broadcast', 'error');
            updateStatus('viewer', 'error');
        });

        elements.startBroadcastBtn.addEventListener('click', startBroadcast);
        elements.stopBroadcastBtn.addEventListener('click', stopBroadcast);
        elements.copyUrlBtn.addEventListener('click', copyBroadcastUrl);
        elements.joinStreamBtn.addEventListener('click', joinStream);
        elements.leaveStreamBtn.addEventListener('click', leaveStream);

        async function startBroadcast() {
            updateStatus('broadcast', 'connecting');
            try {
                const constraints = getStreamConstraints();
                mediaStream = await navigator.mediaDevices.getDisplayMedia(constraints);
                
                if (!mediaStream.getAudioTracks().length && isMobileDevice()) {
                    alert("En dispositivos móviles debes permitir el audio manualmente");
                }

                const previewVideo = document.createElement('video');
                previewVideo.srcObject = mediaStream;
                previewVideo.autoplay = true;
                previewVideo.playsInline = true;
                elements.broadcastPreview.innerHTML = '';
                elements.broadcastPreview.appendChild(previewVideo);

                const url = `${window.location.origin}${window.location.pathname}?watch=${peerId}`;
                elements.broadcastUrl.value = url;

                elements.broadcastInfo.classList.remove('hidden');
                elements.startBroadcastBtn.classList.add('hidden');
                updateStatus('broadcast', 'live');
                broadcastActive = true;

                peer.on('call', (call) => {
                    call.answer(mediaStream);
                    currentCall = call;
                    call.on('close', () => {
                        console.log('Espectador desconectado');
                    });
                });
            } catch (err) {
                console.error('Error al compartir pantalla:', err);
                updateStatus('broadcast', 'error');
                alert('No se pudo iniciar la transmisión.');
            }
        }

        function stopBroadcast() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            elements.broadcastPreview.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                    <!-- ... SVG de vista previa ... -->
                </div>
            `;
            elements.broadcastInfo.classList.add('hidden');
            elements.startBroadcastBtn.classList.remove('hidden');
            updateStatus('broadcast', 'offline');
            broadcastActive = false;
        }

        function joinStream() {
            const streamId = elements.streamIdInput.value.trim();
            if (!streamId) {
                alert('Ingresa un ID válido');
                return;
            }
            updateStatus('viewer', 'connecting');
            
            const call = peer.call(streamId, null);
            currentCall = call;

            call.on('stream', (remoteStream) => {
                const viewerVideo = document.createElement('video');
                viewerVideo.srcObject = remoteStream;
                viewerVideo.autoplay = true;
                viewerVideo.playsInline = true;
                elements.viewerDisplay.innerHTML = '';
                elements.viewerDisplay.appendChild(viewerVideo);
                elements.viewerControls.classList.remove('hidden');
                updateStatus('viewer', 'live');
                viewerActive = true;
            });

            call.on('close', leaveStream);
            call.on('error', (err) => {
                console.error('Error:', err);
                updateStatus('viewer', 'error');
                alert('No se pudo conectar. Verifica el ID.');
            });
        }

        function leaveStream() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            elements.viewerDisplay.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                    <!-- ... SVG de espera ... -->
                </div>
            `;
            elements.viewerControls.classList.add('hidden');
            updateStatus('viewer', 'offline');
            viewerActive = false;
        }

        function copyBroadcastUrl() {
            elements.broadcastUrl.select();
            document.execCommand('copy');
            const originalText = elements.copyUrlBtn.textContent;
            elements.copyUrlBtn.textContent = '¡Copiado!';
            setTimeout(() => {
                elements.copyUrlBtn.textContent = originalText;
            }, 2000);
        }

        function getStreamConstraints() {
            const quality = elements.streamQuality.value;
            const fps = parseInt(elements.streamFps.value);
            let width, height;
            switch (quality) {
                case 'high': width = 1920; height = 1080; break;
                case 'medium': width = 1280; height = 720; break;
                case 'low': width = 854; height = 480; break;
                default: width = 1280; height = 720;
            }
            return {
                video: {
                    width: { ideal: width },
                    height: { ideal: height },
                    frameRate: { ideal: fps, max: fps },
                    cursor: 'always'
                },
                audio: true
            };
        }

        function updateStatus(mode, status) {
            const statusElement = mode === 'broadcast' ? elements.broadcastStatus : elements.viewerStatus;
            statusElement.className = 'status-indicator';
            switch (status) {
                case 'live': statusElement.classList.add('status-live'); break;
                case 'offline': statusElement.classList.add('status-offline'); break;
                case 'connecting': statusElement.classList.add('status-connecting'); break;
                case 'error': statusElement.classList.add('status-error'); break;
                default: statusElement.classList.add('status-offline');
            }
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const watchId = urlParams.get('watch');
            if (watchId) {
                elements.streamIdInput.value = watchId;
            }
        });

        window.addEventListener('beforeunload', () => {
            if (broadcastActive) stopBroadcast();
            if (viewerActive) leaveStream();
        });
    </script>
</body>
</html>
